<!DOCTYPE html>
<html lang="en">

<head>
    <title>Gui B.L Software Engineering-Code and posts about tech and programming</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gui B.L coder and entrepreneur-free tutorials with sample code and topics about tech and programming">
    <meta name="author" content="Guilherme Becker Lamounier">

    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">

    <!-- Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='/font-awesome/css/font-lora.css' rel='stylesheet' type='text/css'>
    <link href='/font-awesome/css/font-montserrat.css' rel='stylesheet' type='text/css'>

    <!-- Custom Theme CSS -->
    <link href="/css/grayscale.css" rel="stylesheet">

    <!-- Syntax highlight CSS -->
    <link href="/css/syntax.css" rel="stylesheet" type="text/css">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-49522383-1', 'guilhebl.github.io');
  ga('send', 'pageview');
</script>

</head>

<body id="page-top" data-spy="scroll" data-target=".navbar-custom">

    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
                    <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="/index.html">
                    <i class="fa fa-play-circle"></i>  <span class="light">guilhebl</span>
                </a>
            </div>

	<div class="col-sm-3 col-md-3 pull-right">
        <div class="input-group">

            <input type="text" class="search-field form-control" placeholder="Search" autocomplete="off">
            <div class="input-group-btn">
                <button class="btn btn-default" type="button"><i class="glyphicon glyphicon-search"></i></button>
            </div>
        </div>
        </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-right navbar-main-collapse">

                <ul class="nav navbar-nav">
                    <!-- Hidden li included to remove active class from about link when scrolled up past about section -->
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li class="page-scroll">
                        <a href="/#postList"><i class="fa fa-home fa-fw marginRight6"></i>Home</a>
                    </li>
                    <li class="page-scroll">
                        <a href="/categories"><i class="fa fa-list-ul fa-fw marginRight6"></i>Pages</a>
                    </li>
                    <li class="page-scroll">
                        <a href="/about"><i class="fa fa-user fa-fw marginRight6"></i>About</a>
                    </li>
                    <li class="page-scroll">
                        <a href="/contact"><i class="fa fa-coffee fa-fw marginRight6"></i>Contact</a>
                    </li>
                </ul>

            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->

        <div class="results resultsBox"></div>
    </nav>


    <section class="post">
        <div class="post-body">
            <div class="container">
		<div class="row-fluid">
		  <div class="center-block">
		     <section class="paper">
		      	<article class="head">Dockerizing a Scala Play application</article>
			<p class="muted">23 August 2017</p>

			<article contenteditable="false"><p>Docker is one of the most popular container technologies in the IT world nowadays.
It provides many benefits such as portability and component isolation along some other features. For more info: <a href="https://www.docker.com/">Docker</a></p>

<p>In this example we are going to dockerize a sample REST API which is built using Scala 2.11.11 and Play Framework 2.6.3.</p>

<h3>Sample Play Docker app - how to run</h3>

<h5>Clone the <a href="https://github.com/guilhebl/play-scala-rest-api-example">project</a></h5>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/guilhebl/play-scala-rest-api-example</code></pre></figure></p>

<h5>compile and run</h5>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">sbt run</code></pre></figure></p>

<h5>Check your app at localhost:9000</h5>

<p>Sample JSON output (http://localhost:9000/v1/posts):</p>

<p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
   </span><span class="p">{</span><span class="w">
      </span><span class="nt">"id"</span><span class="p">:</span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"link"</span><span class="p">:</span><span class="s2">"/v1/posts/1"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"title"</span><span class="p">:</span><span class="s2">"title 1"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"body"</span><span class="p">:</span><span class="s2">"blog post 1"</span><span class="w">
   </span><span class="p">},</span><span class="w">
   </span><span class="p">{</span><span class="w"><br/>
      </span><span class="nt">"id"</span><span class="p">:</span><span class="s2">"2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"link"</span><span class="p">:</span><span class="s2">"/v1/posts/2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"title"</span><span class="p">:</span><span class="s2">"title 2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"body"</span><span class="p">:</span><span class="s2">"blog post 2"</span><span class="w">
   </span><span class="p">},</span><span class="w">
   </span><span class="p">{</span><span class="w"><br/>
      </span><span class="nt">"id"</span><span class="p">:</span><span class="s2">"3"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"link"</span><span class="p">:</span><span class="s2">"/v1/posts/3"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"title"</span><span class="p">:</span><span class="s2">"title 3"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"body"</span><span class="p">:</span><span class="s2">"blog post 3"</span><span class="w">
   </span><span class="p">},</span><span class="w">
   </span><span class="p">{</span><span class="w"><br/>
      </span><span class="nt">"id"</span><span class="p">:</span><span class="s2">"4"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"link"</span><span class="p">:</span><span class="s2">"/v1/posts/4"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"title"</span><span class="p">:</span><span class="s2">"title 4"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"body"</span><span class="p">:</span><span class="s2">"blog post 4"</span><span class="w">
   </span><span class="p">},</span><span class="w">
   </span><span class="p">{</span><span class="w"><br/>
      </span><span class="nt">"id"</span><span class="p">:</span><span class="s2">"5"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"link"</span><span class="p">:</span><span class="s2">"/v1/posts/5"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"title"</span><span class="p">:</span><span class="s2">"title 5"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"body"</span><span class="p">:</span><span class="s2">"blog post 5"</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre></figure></p>

<h3>How to run an app instance inside a Docker container</h3>

<p>In order to dockerize your play rest api example run the following steps:</p>

<h5>Generate secret key - since docker will host our production app we need to generate a secret key.</h5>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">sbt playGenerateSecret</code></pre></figure></p>

<p>copy the secret key (for example: "YtvWptxIlpf@Q[_dPvE[Z6NLAh_KU0YlGvwnN7sV8DKSk>PSBNbzarVp8j?=;l/y")</p>

<h5>Create a new prod dist</h5>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">sbt dist</code></pre></figure></p>

<h5>Generate a new local Docker image</h5>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">sbt docker:publishLocal</code></pre></figure></p>

<h5>Run the play app inside a docker container</h5>

<ul>
<li>replace with your generated key</li>
</ul>


<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker run -p 9000:9000 -e <span class="nv">APPLICATION_SECRET</span><span class="o">=</span><span class="s2">"YtvWptxIlpf@Q[_dPvE[Z6NLAh_KU0YlGvwnN7sV8DKSk&gt;PSBNbzarVp8j?=;l/y"</span> play-scala-rest-api-example:1.0-SNAPSHOT</code></pre></figure></p>

<p>To check the running docker containers run:</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker ps -a</code></pre></figure></p>

<p>Output:</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">CONTAINER ID        IMAGE                                      COMMAND                  CREATED             STATUS                           PORTS                    NAMES
3d0bc5f7b2aa        play-scala-rest-api-example:1.0-SNAPSHOT   <span class="s2">"bin/play-scala-re..."</span>   20 seconds ago      Up 19 seconds                    0.0.0.0:9000-&gt;9000/tcp   admiring_darwin</code></pre></figure></p>

<h5>Misc commands</h5>

<p>to clean the image using sbt-native-packager</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">sbt docker:clean</code></pre></figure></p>

<ul>
<li>In order to stop all running docker containers</li>
</ul>


<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker stop <span class="k">$(</span>docker ps -aq<span class="k">)</span></code></pre></figure></p>

<h3>Docker configuration using sbt-native-packager</h3>

<p>Add to build.sbt the sbt native docker configuration:</p>

<p><figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">javaOptions</span> <span class="n">in</span> <span class="nc">Universal</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="c1">// JVM memory tuning
</span>  <span class="s">"-J-Xmx1024m"</span><span class="o">,</span>
  <span class="s">"-J-Xms128m"</span><span class="o">,</span>
  <span class="c1">// Since play uses separate pidfile we have to provide it with a proper path
</span>  <span class="c1">// name of the pid file must be play.pid
</span>  <span class="n">s</span><span class="s">"-Dpidfile.path=/opt/docker/${packageName.value}/run/play.pid"</span>
<span class="o">)</span></p>

<p><span class="c1">// use ++= to merge a sequence with an existing sequence
</span><span class="n">dockerCommands</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="nc">ExecCmd</span><span class="o">(</span><span class="s">"RUN"</span><span class="o">,</span> <span class="s">"mkdir"</span><span class="o">,</span> <span class="n">s</span><span class="s">"/opt/docker/${packageName.value}"</span><span class="o">),</span>
  <span class="nc">ExecCmd</span><span class="o">(</span><span class="s">"RUN"</span><span class="o">,</span> <span class="s">"mkdir"</span><span class="o">,</span> <span class="n">s</span><span class="s">"/opt/docker/${packageName.value}/run"</span><span class="o">),</span>
  <span class="nc">ExecCmd</span><span class="o">(</span><span class="s">"RUN"</span><span class="o">,</span> <span class="s">"chown"</span><span class="o">,</span> <span class="s">"-R"</span><span class="o">,</span> <span class="s">"daemon:daemon"</span><span class="o">,</span> <span class="n">s</span><span class="s">"/opt/docker/${packageName.value}/"</span><span class="o">)</span>
<span class="o">)</span></p>

<p><span class="c1">// exposing the play ports
</span><span class="n">dockerExposedPorts</span> <span class="n">in</span> <span class="nc">Docker</span> <span class="o">:=</span> <span class="nc">Seq</span><span class="o">(</span><span class="mi">9000</span><span class="o">,</span> <span class="mi">9443</span><span class="o">)</span></code></pre></figure></p>

<p>This will generate a</p>

<p>In our conf/application.conf file we need to change secret key to read from an ENV var:</p>

<p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"> play.http.secret.key<span class="o">=</span><span class="k">${</span><span class="p">?APPLICATION_SECRET</span><span class="k">}</span> </code></pre></figure></p>

<p>This will generate a docker image based on openjdk
In our conf/secure.conf we need to modify trusted proxies in order to load balance in cloud environments:</p>

<p><figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">play</span> <span class="o">{</span>
  <span class="n">http</span> <span class="o">{</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">strict</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="n">session</span><span class="o">.</span><span class="n">secure</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="n">session</span><span class="o">.</span><span class="n">httpOnly</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="n">flash</span><span class="o">.</span><span class="n">secure</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="n">flash</span><span class="o">.</span><span class="n">httpOnly</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="n">forwarded</span><span class="o">.</span><span class="n">trustedProxies</span> <span class="k">=</span> <span class="o">[</span><span class="err">"</span><span class="kt">::</span><span class="err">1"</span>, <span class="err">"127</span><span class="kt">.</span><span class="err">0</span><span class="kt">.</span><span class="err">0</span><span class="kt">.</span><span class="err">1"</span><span class="o">]</span>
  <span class="o">}</span>
  <span class="n">i18n</span> <span class="o">{</span>
    <span class="n">langCookieSecure</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="n">langCookieHttpOnly</span> <span class="k">=</span> <span class="kc">true</span>
  <span class="o">}</span>
  <span class="n">filters</span> <span class="o">{</span>
    <span class="n">csrf</span> <span class="o">{</span>
      <span class="n">cookie</span><span class="o">.</span><span class="n">secure</span> <span class="k">=</span> <span class="kc">true</span>
    <span class="o">}</span>
    <span class="n">hosts</span> <span class="o">{</span>
      <span class="n">allowed</span> <span class="k">=</span> <span class="o">[</span><span class="err">"</span><span class="kt">localhost:</span><span class="err">9443"</span>, <span class="err">"</span><span class="kt">localhost:</span><span class="err">9000"</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="n">hsts</span> <span class="o">{</span>
      <span class="n">maxAge</span> <span class="k">=</span> <span class="mi">1</span> <span class="n">minute</span> <span class="k">#</span> <span class="n">don</span><span class="ss">'t </span><span class="n">interfere</span> <span class="k">with</span> <span class="n">other</span> <span class="n">projects</span>
      <span class="n">secureHost</span> <span class="k">=</span> <span class="s">"localhost"</span>
      <span class="n">securePort</span> <span class="k">=</span> <span class="mi">9443</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure></p>
</article>
		      </section>

		    <div id="disqus_thread"></div>
		    <script type="text/javascript">
			/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			var disqus_shortname = 'guilhebliopages'; // required: replace example with your forum shortname

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
			    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		    </script>
		    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>		    
		  </div>

		</div>
            </div>
        </div>
    </section>
    <!-- Core JavaScript Files -->
    <script src="/js/jquery-1.10.2.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/jquery.easing.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/js/grayscale.js"></script>

    <!-- Plugin Third party JavaScript -->
    <script src="/js/jekyll-search.js"></script>
    <script src="/js/jekyll-search.jquery.js"></script>
 
</body>

</html>


